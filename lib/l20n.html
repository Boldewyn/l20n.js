<!DOCTYPE html>  <html> <head>   <title>l20n.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="compiler.html">                 compiler.js               </a>                                           <a class="source" href="intl.html">                 intl.js               </a>                                           <a class="source" href="l20n.html">                 l20n.js               </a>                                           <a class="source" href="parser.html">                 parser.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               l20n.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">DEBUG</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">L20n</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">L20n</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span>
    <span class="nx">L20n</span><span class="p">.</span><span class="nx">Parser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./parser.js&#39;</span><span class="p">);</span>
    <span class="nx">L20n</span><span class="p">.</span><span class="nx">Compiler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./compiler.js&#39;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">L20n</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">L20n</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>

  <span class="nx">L20n</span><span class="p">.</span><span class="nx">getContext</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">L20n_getContext</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Context</span><span class="p">();</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>clear the Resource cache which stores unprocessed LOL files and which is 
shared across all contexts;  additionally, each context also has its own 
cache for ProcessedResources, which needs to be invalidated independently.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">L20n</span><span class="p">.</span><span class="nx">invalidateCache</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">L20n_invalidateCache</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">resCache</span><span class="p">.</span><span class="nx">invalidate</span><span class="p">();</span>
  <span class="p">};</span>
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>define variables and functions whose implementation is 
environment-dependent.  Test suites can change the implementation to 
support server-side XHR, or to add logic to how URLs are resolved.  See 
/tests/lib/context.js for an example.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">env</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">DEBUG</span><span class="o">:</span> <span class="nx">DEBUG</span><span class="p">,</span>
    <span class="nx">getURL</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">getURL</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>in DEBUG mode, bypass the server cache</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">DEBUG</span> <span class="o">?</span> <span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">:</span> <span class="nx">url</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>for now, we only use node to run tests, so it's safe to assume the test 
suite will provide its own env anyways.  in the future, however, when we 
decide to support node, we should use fs.readFile and fs.readFileSync</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">XMLHttpRequest</span><span class="o">:</span> <span class="k">typeof</span> <span class="nx">exports</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">XMLHttpRequest</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">L20n</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">get</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">env</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">set</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">enumerable</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">configurable</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">debug</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">DEBUG</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">globals</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">get</span> <span class="nx">hour</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getHours</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">get</span> <span class="nx">os</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="sr">/^MacIntel/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;mac&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="sr">/^Linux/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;linux&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="sr">/^Win/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigatgor</span><span class="p">.</span><span class="nx">platform</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;win&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span><span class="p">;</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">EventEmitter</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_listeners</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>

  <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emit</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ee_emit</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">typeListeners</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_listeners</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">typeListeners</span> <span class="o">||</span> <span class="o">!</span><span class="nx">typeListeners</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">typeListeners</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">listener</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ee_add</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_listeners</span><span class="p">[</span><span class="nx">type</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_listeners</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_listeners</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">listener</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeEventListener</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ee_remove</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">typeListeners</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_listeners</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">typeListeners</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">listener</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">listeners</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">Cache</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ctor</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ctor</span> <span class="o">=</span> <span class="nx">ctor</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>
  
  <span class="nx">Cache</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">Cache_get</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctor</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Cache</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">invalidate</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">Cache_invalidate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>keep one cache of Resources for all created contexts</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">resCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Cache</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">Resource</span><span class="p">);</span>


  <span class="kd">function</span> <span class="nx">_ifComplete</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="nx">ifComplete</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">isComplete</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">_fire</span><span class="p">(</span><span class="nx">callbacks</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callbacks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">callbacks</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">Resource</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ast</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">imports</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">callbacks</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">xhr</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>when the resource is downloading, calling its get method will only add 
the specified callback to callbacks, without initiating a new XHR</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">isDownloading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>resource is corrupted when the XHR returned an error;  the resource 
must not be used.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">isCorrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">downloadAsync</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">fallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Async GET &#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
      <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">env</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">();</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">overrideMimeType</span><span class="p">(</span><span class="s1">&#39;text/plain&#39;</span><span class="p">);</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="s1">&#39;fetched&#39;</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="s1">&#39;failed to fetch&#39;</span><span class="p">);</span>
          <span class="nx">isCorrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">fallback</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;abort&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;XHR aborted for &#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;XHR error for &#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
        <span class="nx">fallback</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">env</span><span class="p">.</span><span class="nx">getURL</span><span class="p">(</span><span class="nx">url</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">downloadSync</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">fallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Sync GET &#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
      <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">env</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">();</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">overrideMimeType</span><span class="p">(</span><span class="s1">&#39;text/plain&#39;</span><span class="p">);</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">env</span><span class="p">.</span><span class="nx">getURL</span><span class="p">(</span><span class="nx">url</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="s1">&#39;fetched&#39;</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="s1">&#39;failed to fetch&#39;</span><span class="p">);</span>
        <span class="nx">isCorrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">fallback</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ast</span> <span class="o">=</span> <span class="nx">L20n</span><span class="p">.</span><span class="nx">Parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">body</span><span class="p">;</span>
      <span class="nx">imports</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;ImportStatement&#39;</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="nx">_fire</span><span class="p">(</span><span class="nx">callbacks</span><span class="p">,</span> <span class="p">[</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">imports</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">abortXHR</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;aborting XHR for &#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">r_get</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">fallback</span><span class="p">,</span> <span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ast</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">imports</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isCorrupted</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fallback</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">callbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isDownloading</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">isDownloading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">downloadAsync</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">parse</span><span class="p">,</span> <span class="nx">fallback</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">downloadSync</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">parse</span><span class="p">,</span> <span class="nx">fallback</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">ProcessedResource</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">rawast</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">totalImports</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">callbacks</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ast</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">importedResources</span> <span class="o">=</span> <span class="p">[];</span> <span class="c1">// imported resources in order</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>a preprocessed resource is ready when all its child resources are ready 
and it has been preprocessed to include their ASTs.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">isReady</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>a preprocessed resource is corrupted when its resource is corrupted, or 
any of its child preprocessed resources is corrupted too;  a corrupted 
preprocessed resource must not be used.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">isCorrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">dirname</span> <span class="o">=</span> <span class="nx">id</span> <span class="o">?</span> <span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">resource</span> <span class="o">=</span> <span class="nx">id</span> <span class="o">?</span> <span class="nx">resCache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">relativeToSelf</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">url</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">url</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dirname</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>strip the trailing slash if present</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dirname</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">dirname</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">dirname</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dirname</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dirname</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dirname</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">url</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;./&#39;</span> <span class="o">+</span> <span class="nx">url</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">normalizeURL</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">normalized</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
      <span class="nx">parts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">part</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">part</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>don't do anything</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">part</span> <span class="o">==</span> <span class="s1">&#39;..&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">normalized</span><span class="p">[</span><span class="nx">normalized</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>remove the last element of <code>normalized</code></p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">normalized</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">normalized</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">normalized</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">part</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">normalized</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">_expandUrn</span><span class="p">(</span><span class="nx">urn</span><span class="p">,</span> <span class="nx">vars</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">urn</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\{\{\s*(\w+)\s*\}\})/g</span><span class="p">,</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">vars</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">p2</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">vars</span><span class="p">[</span><span class="nx">p2</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">p1</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">resolveURI</span><span class="p">(</span><span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^l10n:/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">uri</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">normalizeURL</span><span class="p">(</span><span class="nx">relativeToSelf</span><span class="p">(</span><span class="nx">uri</span><span class="p">));</span>
        <span class="k">return</span> <span class="p">[</span><span class="nx">url</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">locales</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;Can&#39;t use schema uris without settings.locales&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^l10n:(?:([^:]+):)?([^:]+)/</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">match</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;Malformed resource scheme: &quot;</span> <span class="o">+</span> <span class="nx">uri</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">vars</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;locale&#39;</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">getLocale</span><span class="p">(),</span>
        <span class="s1">&#39;app&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;resource&#39;</span><span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">schemes</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="s2">&quot;Can&#39;t use schema uris without settings.schemes&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">uri</span> <span class="o">=</span> <span class="p">[</span><span class="nx">normalizeURL</span><span class="p">(</span><span class="nx">_expandUrn</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">vars</span><span class="p">))];</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">vars</span><span class="p">[</span><span class="s1">&#39;app&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="nx">uri</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">self</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">schemes</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">expanded</span> <span class="o">=</span> <span class="nx">_expandUrn</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">schemes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">vars</span><span class="p">);</span>
          <span class="nx">uri</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">normalizeURL</span><span class="p">(</span><span class="nx">expanded</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">uri</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">preprocess</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isReady</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">rawast</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;ImportStatement&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">importedAST</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">importedResources</span><span class="p">.</span><span class="nx">shift</span><span class="p">().</span><span class="nx">ast</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">ast</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">ast</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">importedAST</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">ast</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">isReady</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">_fire</span><span class="p">(</span><span class="nx">callbacks</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">abortImports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">resource</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">abortXHR</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">importedResources</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">imported</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">imported</span><span class="p">.</span><span class="nx">abortImports</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">pr_load</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">fallback</span><span class="p">,</span> <span class="nx">nesting</span><span class="p">,</span> <span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isReady</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isCorrupted</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fallback</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">callbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="kd">function</span> <span class="nx">resolveImports</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">imports</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">rawast</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">;</span>
          <span class="nx">totalImports</span> <span class="o">=</span> <span class="nx">imports</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">totalImports</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">imports</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span>
              <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;importing&#39;</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">importResource</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> 
                                  <span class="nx">_ifComplete</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">preprocess</span><span class="p">),</span> 
                                  <span class="nx">fallback</span><span class="p">,</span> <span class="nx">nesting</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">async</span><span class="p">);</span>
            <span class="p">});</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">ast</span> <span class="o">=</span> <span class="nx">rawast</span><span class="p">;</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">isReady</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="nx">_fire</span><span class="p">(</span><span class="nx">callbacks</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="nx">fallback</span><span class="p">,</span> <span class="nx">async</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">importFirstURL</span><span class="p">(</span><span class="nx">urls</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">fallback</span><span class="p">,</span> <span class="nx">nesting</span><span class="p">,</span> <span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">urls</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">imported</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">importedResources</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">imported</span><span class="p">);</span>
      <span class="nx">imported</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span>
        <span class="kd">function</span> <span class="nx">importSucceeded</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;calling callback,&#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="s1">&#39; loaded OK&#39;</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">();</span>
        <span class="p">},</span> </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p><code>importFailed</code> is the fallback function which is called when the 
imported resource couldn't be loaded.  There are two ways in which 
the load function can fail:
1. the resource file could not be found at the specified URL and 
there are more locations to look for it in; in this case, look for 
the resource in a different location,
2. the resource file could not be found and there are no more URLs 
to try;  in this case, the context cannot be integral and a subctx 
must be created
The second type of failure can happen for the resource that is 
currently being imported, as well as for any other nested import 
inside of it.  The <code>importFailed</code> fallback will be also called from 
this resource's <code>importResource</code> method (or this resource's 
children's <code>importResource</code> method) and the <code>integrityError</code> 
argument is a flag which, when <code>true</code>, indicates that the second 
type of failure has occurred somewhere deeper in the import tree.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">importFailed</span><span class="p">(</span><span class="nx">integrityError</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;calling fallback,&#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="s1">&#39; failed to load&#39;</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">integrityError</span> <span class="o">||</span> <span class="nx">urls</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;no more scheme URLs to try, creating a subcontext&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>fallback to the subctx; true bubbles the integrityError up to 
the parent fallback</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">fallback</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">imported</span><span class="p">.</span><span class="nx">isCorrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>remove the imported resource from imports, so that we don't 
check if it's ready anymore</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">importedResources</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">imported</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">importedResources</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">importFirstURL</span><span class="p">(</span><span class="nx">urls</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">fallback</span><span class="p">,</span> <span class="nx">nesting</span><span class="p">,</span> <span class="nx">async</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="nx">nesting</span><span class="p">,</span> <span class="nx">async</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">importResource</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">pr_importResource</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> 
                                                     <span class="nx">callback</span><span class="p">,</span> 
                                                     <span class="nx">fallback</span><span class="p">,</span> 
                                                     <span class="nx">nesting</span><span class="p">,</span> 
                                                     <span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">nesting</span> <span class="o">=</span> <span class="nx">nesting</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">nesting</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;Too many nested imports&quot;</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>in case the uri is defined in the l10n: scheme, resolve it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">urls</span> <span class="o">=</span> <span class="nx">resolveURI</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span>
      <span class="nx">importFirstURL</span><span class="p">(</span><span class="nx">urls</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">fallback</span><span class="p">,</span> <span class="nx">nesting</span><span class="p">,</span> <span class="nx">async</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">isComplete</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">pr_isComplete</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">importedResources</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">totalImports</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">importedResources</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">importedResources</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">isReady</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">Context</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">entries</span> <span class="o">=</span> <span class="p">{};</span>     <span class="c1">// resource entries</span>
    <span class="kd">var</span> <span class="nx">ctxdata</span> <span class="o">=</span> <span class="p">{};</span>     <span class="c1">// context variables</span>
    <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;schemes&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>    <span class="c1">// path schemes</span>
      <span class="s1">&#39;locales&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>    <span class="c1">// list of locale codes in priority order</span>
      <span class="s1">&#39;timeout&#39;</span><span class="o">:</span> <span class="mi">500</span><span class="p">,</span>     <span class="c1">// timeout for asynchronous resource loading</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>when context is frozen, no more resources can be added to it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">isFrozen</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>context is integral when all the resources have been downloaded</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">isIntegral</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>context is ready when it's integral and compiled</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">isReady</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>a subcontext can be created when 1) the context is not integral, or 2) 
the context is ready, but an entity couldn't be found in it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">subctx</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>contrary to the resCache, the cache for processed resources is 
per-context, because ProcessedResources keep reference to their parent 
context</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Cache</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">ProcessedResource</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Context is a top-level resource that imports other resources.  The only 
difference is that a regular resource is a file, and the EOF marks the 
moment when the resource no longer accepts new imports.  For the 
context's meta resource we need the <code>freeze</code> method to simulate this 
behavior.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">meta</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ProcessedResource</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">cache</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>the URIs of all resources that have been addResource'd;  used for 
creating a subctx</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">uris</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>uris' length, basically;  used in m_isComplete to make sure we're 
checking all resources for readiness</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">totalResources</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="nx">meta</span><span class="p">.</span><span class="nx">isComplete</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">m_isComplete</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isFrozen</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">importedResources</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">totalResources</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">importedResources</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">importedResources</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">isReady</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">isIntegral</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">compile</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isReady</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>flatten the AST</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">meta</span><span class="p">.</span><span class="nx">ast</span> <span class="o">=</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">importedResources</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">curr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">curr</span><span class="p">.</span><span class="nx">ast</span><span class="p">);</span>
      <span class="p">},</span> <span class="p">[]);</span>
      <span class="nx">L20n</span><span class="p">.</span><span class="nx">Compiler</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">entries</span><span class="p">,</span> <span class="nx">globals</span><span class="p">);</span>
      <span class="nx">isReady</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;context ready, current locale is &#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">getLocale</span><span class="p">());</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">getArgs</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">ctxdata</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">args</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">createSubContext</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">subctx</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Context</span><span class="p">();</span>
      <span class="nx">subctx</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">schemes</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">schemes</span><span class="p">;</span>
      <span class="nx">subctx</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">locales</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">locales</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">subctx</span><span class="p">.</span><span class="nx">getLocale</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">throw</span> <span class="s2">&quot;None of the requested locales was available.&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;subcontext\&#39;s locale is &#39;</span><span class="p">,</span> <span class="nx">subctx</span><span class="p">.</span><span class="nx">getLocale</span><span class="p">());</span>
      <span class="nx">uris</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">subctx</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">async</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">subctx</span><span class="p">.</span><span class="nx">freeze</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">subctx</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">invalidateOnIntegrityError</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">isIntegral</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">meta</span><span class="p">.</span><span class="nx">abortImports</span><span class="p">();</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;invalidated context\&#39;s locale was &#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">getLocale</span><span class="p">());</span>
      <span class="nx">subctx</span> <span class="o">=</span> <span class="nx">createSubContext</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="nx">subctx</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">isReady</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">getSync</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isReady</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;Error: context not ready&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isIntegral</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">subctx</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">entity</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">entity</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;entity&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;not found, using subcontext&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">subctx</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;creating subcontext&#39;</span><span class="p">);</span>
          <span class="nx">subctx</span> <span class="o">=</span> <span class="nx">createSubContext</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">subctx</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">entity</span> <span class="o">||</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">local</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;No such entity: &quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">getArgs</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">getAsync</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">defaultValue</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isReady</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">getSync</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">overdue</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">overdue</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>defaultValue is just a string, can't interpolate context data</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">callback</span><span class="p">(</span><span class="nx">defaultValue</span><span class="p">);</span>
      <span class="p">},</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">timeout</span><span class="p">);</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>if the event fired too late, the default value has already been used</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">overdue</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">getSync</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">));</span>
      <span class="p">});</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">__defineSetter__</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ctxdata</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">__defineGetter__</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">ctxdata</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;settings&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">value</span><span class="o">:</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">locales</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">locales</span> <span class="p">},</span>
          <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">throw</span> <span class="s2">&quot;Locales must be a list&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">throw</span> <span class="s2">&quot;Locales list must not be empty&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">locales</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">throw</span> <span class="s2">&quot;Can&#39;t overwrite locales&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">settings</span><span class="p">.</span><span class="nx">locales</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
            <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">locales</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="nx">configurable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="nx">schemes</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">schemes</span> <span class="p">},</span>
          <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">throw</span> <span class="s2">&quot;Schemes must be a list&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">throw</span> <span class="s2">&quot;Scheme list must not be empty&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">schemes</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">throw</span> <span class="s2">&quot;Can&#39;t overwrite schemes&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">settings</span><span class="p">.</span><span class="nx">schemes</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
            <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">schemes</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="nx">configurable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="nx">timeout</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">timeout</span> <span class="p">},</span>
          <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">throw</span> <span class="s2">&quot;Timeout must be a number&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">settings</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
          <span class="p">},</span>
          <span class="nx">configurable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">}),</span>
      <span class="nx">writable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">configurable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">getLocale</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ctx_getLocale</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">locales</span> <span class="o">||</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">locales</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">locales</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>clear this context's ProcessedResources cache</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">invalidateCache</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ctx_invalidateCache</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">invalidate</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">addResource</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ctx_addResource</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">async</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isFrozen</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;Context is frozen, can&#39;t add more resources&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">async</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">uris</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span>
      <span class="nx">meta</span><span class="p">.</span><span class="nx">importResource</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">_ifComplete</span><span class="p">(</span><span class="nx">meta</span><span class="p">,</span> <span class="nx">compile</span><span class="p">),</span> 
                          <span class="nx">invalidateOnIntegrityError</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="nx">async</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">freeze</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ctx_freeze</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">isFrozen</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">totalResources</span> <span class="o">=</span> <span class="nx">uris</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">_ifComplete</span><span class="p">(</span><span class="nx">meta</span><span class="p">,</span> <span class="nx">compile</span><span class="p">)();</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ctx_get</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">fallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getSync</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">getAsync</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">fallback</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">getAttribute</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ctx_getAttribute</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isReady</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;Error: context not ready&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">entity</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">entity</span> <span class="o">||</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">local</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;No such entity: &quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">attribute</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attribute</span> <span class="o">||</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">local</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;No such attribute: &quot;</span> <span class="o">+</span> <span class="nx">attr</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">getArgs</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">getAttributes</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ctx_getAttributes</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isReady</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;Error: context not ready&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">entity</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">entity</span> <span class="o">||</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">local</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;No such entity: &quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">getArgs</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">attr</span> <span class="k">in</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">attribute</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">attr</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attribute</span><span class="p">.</span><span class="nx">local</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">attributes</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">attributes</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ctx_addEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">removeEventListener</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">ctx_removeEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 